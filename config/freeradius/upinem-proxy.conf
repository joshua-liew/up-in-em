##
## upinem-proxy.conf -- 
## UPINEM proxy server configuration file for FreeRADIUS - 3.2.*
##
## Find out more about UPINEM below.
## https://github.com/joshua-liew/up-in-em

######################################################################

# --------------------------------------------------------------
# Proxy server (main) configuration
# --------------------------------------------------------------
proxy server {
    default_fallback = no
    dynamic = no
}


# --------------------------------------------------------------
# Proxy realms section
# --------------------------------------------------------------
# Understanding realms (realms -> server pools -> home servers)
# realms point to server pools, server pools point to home servers
#
# HOME SERVER(S) - server to handle RADIUS request packets
#
# For "type", allowed values are:
#   auth    - Handles Access-Request packets
#   acct    - Handles Accounting-Request packets
#   auth+acct   - Handles Access-Request packets at "port",
#                 and Accounting-Request packets at "port + 1"
#
# INFO: localhost is used for testing - remove in production
home_server localhost {
    type    = auth
    
    # Can use "ipaddr" (IPv4) item or "virtual_server" item 
    ipaddr  = 127.0.0.1
    port    = 1812
    proto   = udp
    secret  = upinem-test

    response_window = 20
    zombie_period   = 40
    revive_internal = 120
    status_check    = status-server
    check_interval  = 30
    check_timeout   = 4
    num_answers_to_alive = 3
    max_outstanding = 65536
}

#home_server eduroam-top-1 { ... }
#home_server eduroam-top-2 { ... }

#
# HOME SERVER POOL(S) - choose home_server to proxy request to
#
# For "type", allowed values are:
#   fail-over - Home server chosen by list-order priority
#   load-balance - Send request to least busy home server
#   client-balance - Home server chosen by hashing source ipaddr
home_server_pool example_auth_pool {
    type = fail-over

    # LIST:
    # ALL home servers listed MUST be of same type e.g. "auth"
    home_server = localhost
    #home_server = secondary.example.com
}

#home_server_pool eduroam-pool {
#   type = fail-over
#   home_server = eduroam-top-1
#   home_server = eduroam-top-2
#}

#
# REALM(S) - choose home_server_pool to proxy request to
#
# For authentication, the "auth_pool" item should point to 
#   pool where ALL home servers listed are of type "auth"
# For accounting, the "acct_pool" item should point to pool
#   where ALL home servers listed are of type "acct"
# For auth+acct, use the "pool" item and specify a pool
#   where ALL home servers listed are of type "auth+acct"
realm example.com {
    auth_pool = example_auth_pool
    #acct_pool = example_acct_pool
    #pool = example_auth+acct_pool
    
    nostrip
}

# Refer to LOCAL realm below - any empty realm or realm with no
# server pool specified causes packets be processed locally
#realm process.me.locally.com { }

# Regex may also be used as realm names
# If used, the "find matching realm" process is as follows
# 
# 1) Look for non-regex realm with an *exact* match for name.
#    If found, it is used in preferance to any regex matching realm.
# 2) Look for regex realm, in order that they are listed.
#    Any regex match is performed in CASE-INSENSITIVE fashion.
#    NOTE: order of realms matters
# 3) If no realm is found, return the DEFAULT realm, if any.

# EDUROAM SPECIFIC:
# Top stub for preventing authentication request loop
# (catch any realms at the institution to avoid loops)
#realm "~^(.+\.)?example\.com$" { }

# Convention: LOCAL realm used mainly to cancel proxying
#  If no server pool is specified, the realm is LOCAL, and 
#  requests are not proxied to it
#  Sets Proxy-To-Realm := LOCAL to achieve this
realm LOCAL { }
# Convention: NULL realm used for requests without explicit
# prefix or suffix e.g. User-Name of "bob"
realm NULL { }
# Convention: DEFAULT realm used for ALL OTHER requests
realm DEFAULT { }

# EDUROAM SPECIFIC:
# By default, proxy unknown realms to top-level RADIUS servers
#realm DEFAULT {
#   pool = eduroam-pool
#   nostrip
#}
