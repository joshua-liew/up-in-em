##
## upinem-vs.conf -- UPINEM virtual server
##   configuration file for FreeRADIUS - 3.2.*
##
## Find out more about UPINEM below.
## https://github.com/joshua-liew/up-in-em

######################################################################

# By default, this server runs due to listen directives
# This server listens on all IP addresses
server upinem-vs {

# --------------------------------------------------------------
# Listen section
# --------------------------------------------------------------
# For "type", allowed values are:
#   auth    - listen for authentication packets
#   acct    - listen for accounting packets
#   auth+acct - listen for both
#   proxy   - IP to use for sending proxied packets
#   status  - listen for Status-Server packets
#
listen {
# Listen on the authentication port (1812) per /etc/services
    type = auth
    ipaddr = *
    port = 0
}

listen {
# Listen on the accounting port (1813) per /etc/services
    type = acct
    ipaddr = *
    port = 0
}


# --------------------------------------------------------------
# Authorization section
# --------------------------------------------------------------
authorize {
    # mods-available/proxy_rate_limit - prevent DoS by proxy
    proxy_rate_limit
    # policy.d/filter - sanitize User-Name attribute
    filter_username
    # mods-available/preprocess - sanitize bizarre attributes
    preprocess
    # policy.d/operator-name - set the Operator-Name attr
    #operator-name
    # policy.d/cui (also mods-available/cui) - set the cui
    #cui
    # mods-available/realm - check realms in user@domain format
    suffix
    
    # TODO: figure out logging for UPINEM
    #upinem-log

    eap {
        ok = return
    }

    # TODO: figure out RADSEC for UPINEM
    # mods-available/tls
    Autz-Type New-TLS-Connection {
        ok
    }

    # TODO: remove after testing
    debug_all
}


# --------------------------------------------------------------
# Authentication section
# --------------------------------------------------------------
# Authentication - auth based on Auth-Type set by autz section
authenticate {
    # mods-available/eap - EAP module to handle 802.1x
    eap
}
# Pre-accounting - decide which accounting type to use later
# TODO: figure out if accounting is needed for UPINEM
preacct {
}
# Post-authentication - additional steps to take after auth
post-auth {
    # TODO: figure out logging for UPINEM
    # policy.d/cui - run cui before logging
    #cui
    #upinem-log
    
    # policy.d/eap - remove Reply-Message from response if EAP
    remove_reply_message_if_eap

    # Handle Access-Reject packets
    Post-Auth-Type REJECT {
        # mods-available/attr_filter
        # mods-config/attr_filter/access_reject
        # - enforce RFC requirements on Access-Reject packets
        attr_filter.access_reject
        # policy.d/eap - add EAP-Failure if rejected by policy 
        eap
        # policy.d/eap - handle EAP-Message attr
        remove_reply_message_if_eap
        # TODO: figure out logging for UPINEM
        #upinem-log
    }

    # Handle Access-Challenge packets
    Post-Auth-Type Challenge {
        # policy.d/eap - handle EAP-Message attr
        remove_reply_message_if_eap
        # mods-available/attr_filter
        # mods-config/attr_filter/access_challenge
        # - enforce RFC requirements on Access-Challenge packets
        attr_filter.access_challenge.post-auth
    }
}


# --------------------------------------------------------------
# Accounting section
# --------------------------------------------------------------
# TODO: figure out if accounting is needed for UPINEM
# Accounting - log the accounting data
accounting {
}


# --------------------------------------------------------------
# Proxy section
# --------------------------------------------------------------
# Pre-proxy - logic before proxying to home server
pre-proxy {
    # policy.d/cui (also mods-available/cui) - request cui
    #cui
    # mods-available/attr_filter
    # mods-config/attr_filter/pre-proxy
    # - filters attributes in packets proxied to home server
    attr_filter.pre-proxy
}
# Post-proxy - logic after receiving response from home server
pre-proxy {
    # policy.d/cui (also mods-available/cui) - request cui
    #cui
    # mods-available/attr_filter
    # mods-config/attr_filter/post-proxy
    # - filters attributes in packets proxied to home server
    attr_filter.post-proxy
}

}
